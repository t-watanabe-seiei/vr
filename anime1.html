<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>hit-box test</title>
    　
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/three@0.131.3/examples/js/loaders/TDSLoader.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
    <script>
      AFRAME.registerComponent("vr-controller", {
        init: function () {

          //トリガーを押した時に球を発射 
          this.el.addEventListener('triggerdown', function (e) {
              //コントローラの位置を取得(thisはコントローラ)
              var point = this.object3D.getWorldPosition();
              //ボールを生成
              var ball = document.createElement('a-sphere');
              ball.setAttribute('class', 'ball');
              ball.setAttribute('scale', '0.2 0.2 0.2');
              ball.setAttribute('position', point);
              //dynamic-bodyを設定することで物理演算をさせる
              ball.setAttribute('dynamic-body', 'shape: sphere; sphereRadius:0.2; ');
              //コントローラのレイキャスターの向きを取得
              var dir = this.getAttribute("raycaster").direction;
              //球を発射するときの向きと大きさを設定(好みに応じて変更) 
              var force = new THREE.Vector3(dir.x, dir.y, dir.z);
              force.multiplyScalar(2000);
              //レイキャスターの向きはコントローラを原点としたローカル座標系なのでワールド座標に変換                   
              ball.force = this.object3D.localToWorld(force);
              //上記の設定を済ませた球をシーンに登場させる
              var scene = document.querySelector('a-scene');
              scene.appendChild(ball);
              //物理関係の設定が済んだタイミングで球を飛ばす 
              ball.addEventListener('body-loaded', function (e) {
                  //ボールの位置を取得(ここでのthisはballを示す)
                  var p = this.object3D.position;
                  //加える力は先ほど計算したものを使用
                  var f = this.force;
                  //球に力を加えて飛ばす
                  this.body.applyForce(
                      new CANNON.Vec3(f.x, f.y, f.z),
                      new CANNON.Vec3(p.x, p.y, p.z)
                  );
              });

              // ボールが衝突したときのイベントを設定
              ball.addEventListener('collide', function (e) {
                  var targetEl = e.detail.body.el; // 衝突相手のエンティティ
                  if (targetEl) {
                      var targetId = targetEl.getAttribute('id'); // 衝突相手のIDを取得
                      if (targetId) {
                          txt.setAttribute("value", targetId); // 衝突相手のIDを表示
                      }
                  }
              });



          });

          //Aボタンを押した時(球を全部削除する) 
          this.el.addEventListener('abuttondown', function (e) {
            //a-sceneに存在する球を全て取得
            var els = document.querySelectorAll('.ball');
            //球を削除
            for (var i = 0; i < els.length; i++) {
              els[i].parentNode.removeChild(els[i]);
            }
          });


          const txt = document.getElementById("my_text");
          const el = this.el;

          // raycasterにぶつかったオブジェクト
          el.selectedObject = null;

          // コントローラーのグリップボタンが押されているかを表現する
          el.grip = false;
        },

        tick: function () {
          var el = this.el;
          if (!el.selectedObject) {
            return;
          }
          if (!el.grip) {
            return;
          }

          // オブジェクトとぶつかったraycaster(コントローラー原点の座標)を取得
          var ray = el.getAttribute("raycaster").direction;

          // コントローラーから見たraycasterとの方向のみを取り出す
          // raycasterとぶつかった部分と同じ位置にオブジェクトを動かす場合はfarと同じにする
          // 引き寄せる場合はfarよりも小さくする
          // コントローラの1.2m手前の座標を計算（コントローラーが原点）
          var p = new THREE.Vector3(ray.x, ray.y, ray.z);
          p.normalize();
          p.multiplyScalar(1.2);

          // コントローラー原点からワールド原点に変換して新しいオブジェクトの位置を計算する
          // ローカル座標（コントローラ中心）をワールド座標に変換
          el.object3D.localToWorld(p);

          // オブジェクトを移動させる（raycasterの先端にオブジェクトを追従させる）
          el.selectedObject.object3D.position.set(p.x, p.y, p.z);
        }
      });


        
        AFRAME.registerComponent('hit-box', {
            init: function () {
                // akaeiModel_01のエンティティを取得
                const model = document.getElementById('target3DModel');

                this.el.addEventListener('click', () => {
                    console.log('clicked!');
                    console.log('@@');
                    console.log(model.getAttribute('position'));
                    // クリックされたら、モデルを非表示にする
                    model.removeAttribute('gltf-model');
                    model.setAttribute('gltf-model', '#akaeiModel_02');

                    setTimeout(removeModel, 4000, "該当modelを削除します", model);
                });


                const removeModel = function (msg1, model) {
                    console.log(msg1);
                    model.removeAttribute('gltf-model');
                    setTimeout(reDirectPage, 2000, "次のページへ遷移します,", model);
                };

                const reDirectPage = function (msg1) {
                    console.log(msg1);
                    //次のページへ遷移
                    // window.location.href = 'artwork01.html';

                    //　背景を変更 a-sky
                    // const model = document.getElementById('aSky');
                    // model.setAttribute('src', '#sky02');
                    const model = document.getElementById('akaeiGroup');
                    console.log(model.getAttribute('position'));
                    model.setAttribute('position','32 -1.6 3')

                    const model2 = document.getElementById('target3DModel');
                    model2.removeAttribute('gltf-model');
                    model2.setAttribute('gltf-model', '#akaeiModel_01');
                    model2.setAttribute('scale', '10 10 10');
                    model2.setAttribute('rotation', '0 -90 0');
                };

            }

        });



    </script>
</head>

<body>
        <a-scene physics="debug: false; gravity: 0; restitution: 0.9; ">
        <a-assets>
            <a-asset-item id="akaeiModel_01" src="./assets/akaei-swing-dance.glb"></a-asset-item>
            <a-asset-item id="akaeiModel_02" src="./assets/akaeiDying02.glb"></a-asset-item>
            <img id="sky01" src="./assets/R0010034.JPG">
            <img id="sky02" src="./assets/R0010035.JPG">
            <img id="sky03" src="./assets/R0010041.JPG">
        </a-assets>

        <!-- マウスカーソル -->
        <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .raycastable"></a-entity>

        <!-- Controller -->
        <a-entity laser-controls="hand: left" raycaster="objects: .collidable; far: 5" vr-controller></a-entity>
        <a-entity laser-controls="hand: right" raycaster="objects: .collidable; far: 5" vr-controller></a-entity>

        
        <!-- クリックしたいentityグループ -->
        <a-entity id="akaeiGroup" position="0 1.6 -1">
            <!-- 3Dモデル -->
            <a-entity id="target3DModel" gltf-model="#akaeiModel_01" scale="1 1 1" rotation="0 0 0" animation-mixer>

                <!-- 当たり判定オブジェクト -->
                <a-entity position="0 -0.05 0" hit-box>
                    <a-entity class="raycastable" geometry="primitive:cylinder" material="color:red; opacity: 0.1"
                        scale="0.1 0.2 0.18" position="0 0.2 0" visible="true"></a-entity>
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- 360度画像を表示 -->
        <a-sky id="aSky" src="#sky01"></a-sky> <!--正門-->
    </a-scene>
</body>

</html>